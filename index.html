<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jolt Operations Dashboard</title>
    <link rel="stylesheet" href="jolt_styles.css">
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
</head>
<body>
 
<div class="dashboard-container">
    
    <!-- LEFT SIDEBAR (Desktop) / BOTTOM NAV (Mobile) -->
    <aside class="sidebar">
        <div class="brand">
  <img src="LogoFace.png" alt="Wenspok Logo" style="height: 24px; margin-right: 10px; vertical-align: middle;">
  
  Wenspok Jolt
</div>

        <nav class="nav-menu">
            
            <!-- SECTION 1: LISTS -->
            <div class="nav-section">
                <div class="nav-header">Lists</div>
                <button id="nav-inspector" class="nav-btn active" onclick="switchTab('inspector')">
                    <span class="icon">üìã</span> <span class="label">List Inspector</span>
                </button>
                <button id="nav-positional" class="nav-btn" onclick="switchTab('positional')">
                    <span class="icon">üßπ</span> <span class="label">Positional Cleaning</span>
                </button>
            </div>

            <!-- SECTION 2: FOOD SAFETY -->
           <div class="nav-section">
                <div class="nav-header">Food Safety</div>
                <button id="nav-grid" class="nav-btn" onclick="switchTab('grid')">
                    <span class="icon">üìä</span> <span class="label">DFSL Grid</span>
                </button>
                <button id="nav-report" class="nav-btn" onclick="switchTab('report')">
                    <span class="icon">üìÑ</span> <span class="label">DFSL Report</span>
                </button>
                <button id="nav-probeGrid" class="nav-btn" onclick="switchTab('probeGrid')">
                    <span class="icon">üå°Ô∏è</span> <span class="label">Probe & Sensor</span>
                </button>
                <button id="nav-sensors" class="nav-btn" onclick="switchTab('sensors')">
                    <span class="icon">üì°</span> <span class="label">Sensors</span>
                </button>
            </div>

            <!-- SECTION 3: MONTHLY SAFETY -->
            <div class="nav-section">
                <div class="nav-header">Monthly Safety</div>
                <button id="nav-audits" class="nav-btn" onclick="switchTab('audits')">
                    <span class="icon">üõ°Ô∏è</span> <span class="label">Safety Audits</span>
                </button>
                <button id="nav-safety-grid" class="nav-btn" onclick="switchTab('safety-grid')">
                    <span class="icon">‚õëÔ∏è</span> <span class="label">Safety Grid</span>
                </button>
                
            </div>
            <div id="nav-admin-section" class="nav-section" style="display:none;">
            <div class="nav-header">Admin Controls</div>
             <button id="nav-admin" class="nav-btn" onclick="switchTab('admin')">
              <span class="icon">‚öôÔ∏è</span> <span class="label">Control Panel</span>
             </button>
            </div>

        </nav>

        <div class="sidebar-footer">
    <button onclick="handleLogout()" class="nav-btn logout-btn" style="margin-bottom: 10px;">
        <span class="icon" style="opacity: 0.8;">üö™</span> <span class="label">Log Out</span>
    </button>
    
    <button onclick="document.getElementById('configModal').style.display='flex'" class="config-trigger">
        ‚öôÔ∏è Settings
    </button>
</div>
<div id="sidebarUserDisplay" style="margin-top: auto; padding: 15px; font-size: 0.9rem; color: #94a3b8; border-top: 1px solid #334155;">
            Welcome, User
        </div>
    </aside>
    <!-- MAIN CONTENT AREA -->
    <main class="content-area">
        
        <!-- Header for Mobile/Context -->
        <header class="mobile-header">
            <h2>Operations Dashboard</h2>
        </header>

        <!-- VIEW 1: INSPECTOR -->
<div id="tab-inspector" class="view-content active">
    <div class="card">
        <div class="card-header">
            <h2>List Inspector</h2>
            <div class="legend-box hide-mobile">
                <span class="legend-item">üõ°Ô∏è Score</span>
                <span class="legend-item"><span style="color:red">üî¥</span> Expired</span>
                <span class="legend-item"><span style="color:gold">üü°</span> Due Today</span>
            </div>
        </div>

        <div class="controls-bar">
            <div class="filter-content">
                <div class="control-group">
                    <label for="marketFilter">Market</label>
                    <select id="marketFilter" onchange="updateOpsGridHierarchy('market')">
                        <option value="">All Markets</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="districtFilter">District</label>
                    <select id="districtFilter" onchange="updateOpsGridHierarchy('district')">
                        <option value="">All Districts</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="locationSelect">Location</label>
                    <select id="locationSelect">
                        <option value="">All Locations</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label for="startDate">Start Date</label>
                    <input type="date" id="startDate">
                </div>

                <div class="control-group">
                    <label for="endDate">End Date</label>
                    <input type="date" id="endDate">
                </div>

                <div class="button-group" style="margin-left: 0;">
                    <button class="btn-primary" onclick="fetchChecklists()">View Lists</button>
                </div>
            </div>
        </div>

        <div class="split-view">
            <div class="list-sidebar" id="listSidebar">
                <div class="empty-state">Select filters and click View Lists</div>
            </div>
            
            <div class="detail-panel mobile-hidden" id="detailView">
                <div class="mobile-nav-header">
                    <button class="btn-secondary back-btn" onclick="backToMobileList('listSidebar', 'detailView')">‚Üê Back to List</button>
                </div>
                <div class="empty-state">
                    <h3>Select a list</h3>
                    <p>Details will appear here</p>
                </div>
            </div>
        </div>
    </div> 
</div>


        <!-- VIEW: POSITIONAL CLEANING -->
<div id="tab-positional" class="view-content">
    <div class="card">
        <div class="card-header">
            <h2>Positional Cleaning</h2>
        </div>

        <div class="controls-bar">
            <div class="filter-content">
                <div class="control-group">
                    <label>Start Date</label>
                    <input type="date" id="posStartDate">
                </div>
                <div class="control-group">
                    <label>End Date</label>
                    <input type="date" id="posEndDate">
                </div>

                <div class="control-group">
                    <label>Market</label>
                    <select id="posMarketFilter" onchange="updatePosGridHierarchy('market')">
                        <option value="">All Markets</option>
                    </select>
                </div>

                <div class="control-group">
                    <label>District</label>
                    <select id="posDistrictFilter" onchange="updatePosGridHierarchy('district')">
                        <option value="">All Districts</option>
                    </select>
                </div>

                <div class="control-group">
                    <label>Location</label>
                    <select id="posLocationFilter">
                        <option value="">All Locations</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label>Day</label>
                    <select id="posDayFilter">
                        <option value="Monday">Monday</option>
                        <option value="Tuesday">Tuesday</option>
                        <option value="Wednesday">Wednesday</option>
                        <option value="Thursday">Thursday</option>
                        <option value="Friday">Friday</option>
                        <option value="Saturday">Saturday</option>
                        <option value="Sunday">Sunday</option>
                    </select>
                </div>

                <div class="control-group">
                    <label>Daypart</label>
                    <select id="posDaypartFilter">
                        <option value="DP 1-3">DP 1-3</option>
                        <option value="DP 4-6">DP 4-6</option>
                    </select>
                </div>

                <div class="button-group">
                    <button class="btn-primary" onclick="loadPositionalCleaningGrid()">Load Grid</button>
                </div>
            </div>
        </div>

        <div class="table-responsive">
            <table class="modern-table" id="posTable">
                <thead>
                    <tr>
                        <th>Site Name</th>
                        <!-- Dynamic Columns will be injected here -->
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="100%" style="text-align:center; padding:30px;">Select filters and click Load Grid.</td></tr>
                </tbody>
            </table>
        </div>
    </div> 
</div>

        <!-- VIEW 2: DFSL GRID (Renamed) -->
<div id="tab-grid" class="view-content">
    <div class="card">
        <div class="card-header">
            <h2>DFSL Grid</h2>
        </div>
        <div class="controls-bar">
            <details open class="filter-toggle">
                <summary class="btn-secondary filter-summary">‚öôÔ∏è Show Filters</summary>
                <div class="filter-content">
                    <div class="control-group">
                        <label>Date</label>
                        <input type="date" id="gridDate">
                    </div>
                    
                    <div class="control-group">
                        <label>Market</label>
                        <select id="gridMarketFilter" onchange="updateGridFilters('market')">
                            <option value="">All Markets</option>
                        </select>
                    </div>

                    <div class="control-group">
                        <label>District</label>
                        <select id="gridDistrictFilter" onchange="updateGridFilters('district')">
                            <option value="">All Districts</option>
                        </select>
                    </div>

                    <div class="control-group">
                        <label>Location</label>
                        <select id="gridLocationFilter">
                            <option value="">All Locations</option>
                        </select>
                    </div>

                    <div class="control-group">
                        <label>&nbsp;</label> <div style="display:flex; align-items:center; gap:10px; height:38px;"><label style="cursor:pointer; display:flex; align-items:center; gap:6px; white-space:nowrap; font-weight:600; color:#334155;">
                            <input type="checkbox" id="gridGroupToggle" style="margin:0; min-width:auto; width:auto;"> Group By Org
                        </label>
                        <button id="gridCollapseBtn" class="btn-secondary" style="display:none; padding:4px 8px; font-size:0.75rem;" onclick="toggleGroupCollapse('grid')">Collapse All</button></div>
                    </div>

                    <div class="button-group">
                        <button class="btn-primary" onclick="loadStoreGrid()">Load Grid</button>
                        <button class="btn-secondary" onclick="printGrid()">Print / Save PDF</button>
                        <button class="btn-secondary" onclick="exportGridToCSV()">Export CSV</button>
                    </div>
                </div>
            </details>
        </div>
        
        <div class="table-responsive">
            <div id="gridPrintHeader" class="only-print"></div>
            <table class="modern-table" id="storeTable">
                <thead>
                    <tr>
                        <th>Store Name</th>
                        <th>Daypart 1</th>
                        <th>Daypart 3</th>
                        <th>Daypart 5</th>
                        <th>Sanitizer</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="5" style="text-align:center; padding:30px;">No data loaded.</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

        <!-- VIEW 3: SAFETY GRID -->
        <div id="tab-safety-grid" class="view-content">
            <div class="card">
                <div class="card-header">
                    <h2>Safety Audit Grid</h2>
                    <span id="safetyGridLastRefreshed" style="font-size: 0.8rem; color: #666;"></span>
                </div>
                <div class="controls-bar">
                    <details open class="filter-toggle">
                        <summary class="btn-secondary filter-summary">‚öôÔ∏è Show Filters</summary>
                        <div class="filter-content">
    <div class="control-group">
        <label>Month</label>
        <input type="month" id="safetyMonth">
    </div>

    <div class="control-group">
    <label>Market</label>
    <select id="safetyMarketFilter" onchange="updateSafetyFilters('market')">
        <option value="">All Markets</option>
    </select>
</div>

<div class="control-group">
    <label>District</label>
    <select id="safetyDistrictFilter" onchange="updateSafetyFilters('district')">
        <option value="">All Districts</option>
    </select>
</div>

<div class="control-group">
    <label>Location</label>
    <select id="safetyLocationFilter">
        <option value="">All Locations</option>
    </select>
</div>

<div class="control-group">
    <label>&nbsp;</label> <div style="display:flex; align-items:center; gap:10px; height:38px;"><label style="cursor:pointer; display:flex; align-items:center; gap:6px; white-space:nowrap; font-weight:600; color:#334155;">
        <input type="checkbox" id="safetyGroupToggle" style="margin:0; min-width:auto; width:auto;"> Group By Org
    </label>
    <button id="safetyCollapseBtn" class="btn-secondary" style="display:none; padding:4px 8px; font-size:0.75rem;" onclick="toggleGroupCollapse('safety')">Collapse All</button></div>
</div>
    <div class="button-group">
        <button class="btn-primary" onclick="loadSafetyGrid()">Load Grid</button>
        <button class="btn-secondary" onclick="printSafetyGrid()">Print / Save PDF</button>
        <button class="btn-secondary" onclick="exportSafetyGridCSV()">Export CSV</button>
    </div>
</div>
                    </details>
                </div>
                
                <div class="table-responsive">
                    <div id="safetyPrintHeader" class="only-print"></div>
                    <table class="modern-table" id="safetyTable">
                        <thead>
                            <tr>
                                <th>Site</th>
                                <th>Monthly Safety Audit</th>
                                <th>Safety Committee Agenda</th>
                                <th>Complete?</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="4" style="text-align:center; padding:30px;">No data loaded.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- VIEW 4: REPORT -->
        <div id="tab-report" class="view-content">
            <div class="card">
                <div class="controls-bar no-print">
                    <details open class="filter-toggle">
                        <summary class="btn-secondary filter-summary">‚öôÔ∏è Show Filters</summary>
                        <div class="filter-content">
                            <div class="control-group">
                                <label>Location</label>
                                <select id="reportLocationSelect"><option>Loading...</option></select>
                            </div>
                            <div class="control-group">
                                <label>Date</label>
                                <input type="date" id="reportDate">
                            </div>
                            <div class="button-group">
                                <button class="btn-primary" onclick="generateSingleReport()">Generate</button>
                                <button class="btn-secondary" onclick="window.print()">Print/PDF</button>
                            </div>
                        </div>
                    </details>
                </div>

                <div class="report-wrapper">
                    <div class="report-page" id="reportContent">
                        <div class="empty-state">Select Location & Date to generate report.</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW 5: AUDITS -->
        <div id="tab-audits" class="view-content">
            <div class="card">
                <div class="card-header">
                    <h2>Safety Audits (Detail)</h2>
                </div>
                <div class="controls-bar no-print">
                    <details open class="filter-toggle">
                        <summary class="btn-secondary filter-summary">‚öôÔ∏è Show Filters</summary>
                        <div class="filter-content">
                            <div class="control-group">
                                <label>Location</label>
                                <select id="auditLocationSelect"><option>Loading...</option></select>
                            </div>
                            <div class="control-group">
                                <label>Month</label>
                                <input type="month" id="auditMonth">
                            </div>
                            <div class="button-group">
    <button class="btn-primary" onclick="fetchAudits()">View Audits</button>
    <button class="btn-secondary" onclick="printAuditDetail()">Print</button>
</div>
                        </div>
                    </details>
                </div>

                <div class="split-view">
                    <div class="list-sidebar" id="auditSidebar">
                        <div class="empty-state">Select location & month</div>
                    </div>
                    
                    <div class="detail-panel mobile-hidden" id="auditDetailView">
                         <div class="mobile-nav-header">
                            <button class="btn-secondary back-btn" onclick="backToMobileList('auditSidebar', 'auditDetailView')">‚Üê Back to List</button>
                       </div>
                        <div class="empty-state">
                            <h3>Select an audit</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="tab-probeGrid" class="view-content">
    <div class="card">
        <div class="card-header">
            <h2>Probe & Sensor Report</h2>
            <span id="probeGridLastRefreshed" style="font-size: 0.8rem; color: #666;"></span>
        </div>
        <div class="controls-bar">
            <details open class="filter-toggle">
                <summary class="btn-secondary filter-summary">‚öôÔ∏è Show Filters</summary>
                <div class="filter-content">
                    
                    <div class="control-group">
                        <label>Start Date</label>
                        <input type="date" id="probeStartDate_v2">
                    </div>
                    <div class="control-group">
                        <label>End Date</label>
                        <input type="date" id="probeEndDate_v2">
                    </div>
                    
                    <div class="control-group">
                        <label>Market</label>
                        <select id="probeMarketFilter_v2" onchange="updateProbeFilters_v2('market')">
                            <option value="">All Markets</option>
                            <option disabled>Loading...</option>
                        </select>
                    </div>

                    <div class="control-group">
                        <label>District</label>
                        <select id="probeDistrictFilter_v2" onchange="updateProbeFilters_v2('district')">
                            <option value="">All Districts</option>
                            <option disabled>Loading...</option>
                        </select>
                    </div>

                    <div class="control-group">
                        <label>Location</label>
                        <select id="probeLocationFilter_v2">
                            <option value="">All Locations</option>
                            <option disabled>Select District...</option>
                        </select>
                    </div>

                    <div class="control-group">
                        <label>&nbsp;</label> <label style="cursor:pointer; display:flex; align-items:center; gap:6px; height:38px; white-space:nowrap; font-weight:600; color:#334155;">
                            <input type="checkbox" id="probeGroupToggle_v2" style="margin:0; min-width:auto; width:auto;"> Group By Organization
                        </label>
                    </div>

                    <div class="button-group">
                        <button class="btn-primary" onclick="loadProbeGrid_v2()">Load Grid</button>
                        <button class="btn-secondary" onclick="window.print()">Print / PDF</button>
                        <button class="btn-secondary" onclick="exportProbeGridCSV_v2()">Export CSV</button>
                    </div>
                </div>
            </details>
        </div>
        
        <div class="table-responsive">
            <div id="probePrintHeader" class="only-print"></div>
            <table class="modern-table" id="probeTable">
                <thead>
                    <tr>
                        <th>Site Name</th>
                        <th>Probe Usage %</th>
                        <th>Sensor Usage %</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="3" style="text-align:center; padding:30px;">Select filters and click Load Grid.</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- VIEW 6: SENSORS (NEW) -->
<div id="tab-sensors" class="view-content">
    <div class="card">
        <div class="card-header">
            <h2>Sensor Status</h2>
            <div class="legend-box hide-mobile" style="margin-right: auto; margin-left: 20px;">
                <span class="legend-item">‚ùó Critical Temp</span>
                <span class="legend-item">‚ö†Ô∏è Temp Warning</span>
            </div>
            <button class="btn-primary" onclick="loadSensorsGrid()">Refresh</button>
        </div>
        <div class="controls-bar">
             <div class="filter-content">
                <div class="control-group">
                    <label>Search</label>
                    <input type="text" id="sensorSearch" placeholder="Search Site..." onkeyup="filterSensorCards()" style="width: 140px;">
                </div>
                <div class="control-group">
                    <label>Status</label>
                    <select id="sensorStatusFilter" onchange="filterSensorCards()">
                        <option value="all">Show All</option>
                        <option value="crit">Critical Alerts</option>
                        <option value="warn">Warnings</option>
                        <option value="batt">Battery Issues</option>
                        <option value="sig">Signal/Disconnect</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Market</label>
                    <select id="sensorMarketFilter" onchange="updateSensorFilters('market')">
                        <option value="">All Markets</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>District</label>
                    <select id="sensorDistrictFilter" onchange="updateSensorFilters('district')">
                        <option value="">All Districts</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>&nbsp;</label> <div style="display:flex; align-items:center; gap:10px; height:38px;"><label style="cursor:pointer; display:flex; align-items:center; gap:6px; white-space:nowrap; font-weight:600; color:#334155;">
                        <input type="checkbox" id="sensorGroupToggle" style="margin:0; min-width:auto; width:auto;"> Group By Org
                    </label>
                    <button id="sensorCollapseBtn" class="btn-secondary" style="display:none; padding:4px 8px; font-size:0.75rem;" onclick="toggleGroupCollapse('sensor')">Collapse All</button></div>
                </div>
                <div class="button-group">
                    <button class="btn-primary" onclick="loadSensorsGrid()">Load Sensors</button>
                </div>
             </div>
        </div>
        <div id="sensorGridContainer" class="sensor-grid">
            <div style="grid-column: 1/-1; text-align:center; padding:40px; color:#666;">Select filters and click Load Sensors</div>
        </div>
    </div>
</div>

<div id="tab-admin" class="view-content">
    <div class="card">
        <div class="card-header">
             <h2>User Control Panel</h2>
            <button class="btn-primary" onclick="openCreateUserModal()">+ New User</button>
        </div>
        
        <datalist id="scopeOptions"></datalist>

        <div class="table-responsive">
            <table class="modern-table" id="adminUserTable">
                <thead>
                    <tr>
                        <th style="width: 20%;">Name</th>
                        <th style="width: 25%;">Email</th>
                        <th style="width: 15%;">Role</th>
                        <th style="width: 25%;">Scope</th>
                        <th style="width: 15%;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>
    </div>
</div>


    </main>
</div>

<!-- MODALS -->
<div id="photoModal" onclick="if(event.target === this) closePhoto()">
    <div class="photo-content" onclick="event.stopPropagation()">
        <button class="close-photo" onclick="closePhoto()">Close</button>
        <h3 id="photoTitle" style="margin-bottom:5px;">Photo Details</h3>
        <div id="photoCaption" style="margin-bottom:15px;"></div>
        
        <div style="position:relative; display:flex; align-items:center; justify-content:center; min-height:300px;">
            <button id="photoPrev" onclick="navigatePhoto(-1)" style="position:absolute; left:-50px; background:rgba(255,255,255,0.2); color:white; border:none; font-size:2rem; cursor:pointer; padding:10px; border-radius:50%; width:50px; height:50px; display:flex; align-items:center; justify-content:center;">‚Äπ</button>
            
            <div id="photoContainer">
                <!-- Image injected here -->
            </div>
            
            <button id="photoNext" onclick="navigatePhoto(1)" style="position:absolute; right:-50px; background:rgba(255,255,255,0.2); color:white; border:none; font-size:2rem; cursor:pointer; padding:10px; border-radius:50%; width:50px; height:50px; display:flex; align-items:center; justify-content:center;">‚Ä∫</button>
        </div>
        
        <div id="photoCounter" style="color:#94a3b8; font-size:0.75rem; margin-top:15px; border-top:1px solid #eee; padding-top:8px;"></div>
    </div>
</div>

<!-- SENSOR DETAIL MODAL -->
<div id="sensorDetailModal" class="modal" style="display:none; position:fixed; z-index:9000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.5); align-items:center; justify-content:center;">
    <div class="modal-content" style="background:white; padding:20px; border-radius:12px; width:550px; max-width:95%; max-height:85vh; overflow-y:auto; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;">
            <h3 id="sensorModalTitle" style="margin:0;">Site Sensors</h3>
            <button onclick="document.getElementById('sensorDetailModal').style.display='none'" class="btn-secondary" style="padding:4px 10px;">Close</button>
        </div>
        <div id="sensorModalContent">Loading...</div>
    </div>
</div>

<div id="loadingOverlay"><div class="loader"></div><h2 id="loadingText">Processing...</h2><p id="loadingSubtext">Please wait.</p></div>
<div id="system-log" style="display:none;"></div>
<div id="configModal"><div class="modal-content"><h3>API Connection Settings</h3><p style="font-size: 0.8rem; color: #666;">Adjust these only if connection fails.</p><div class="modal-row"><label>Proxy URL (Worker)</label><input type="text" id="cfg-url" value="https://jolt-proxy.ckuran.workers.dev"></div><div class="modal-row" style="opacity: 0.5;"><label>Auth Token (Managed by Worker)</label><input type="text" id="cfg-token-val" placeholder="(Hidden)" disabled></div><div style="text-align: right; margin-top: 15px;"><button onclick="saveConfig()" class="btn-primary">Save & Reload</button><button onclick="document.getElementById('configModal').style.display='none'" style="padding: 9px;">Cancel</button></div></div></div>
<div id="loginOverlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#1e293b; z-index:9999; display:flex; justify-content:center; align-items:center; flex-direction:column; color:white;">
    <div style="background:white; padding:40px; border-radius:12px; box-shadow:0 10px 25px rgba(0,0,0,0.5); text-align:center; color:#333; max-width:400px; width:90%;">
        <h1 style="margin-bottom:10px;">‚ö° Jolt Ops</h1>
        <p style="color:#666; margin-bottom:20px;">Please sign in to access the dashboard.</p>
        
        <input type="email" id="txtEmail" placeholder="Email" style="width:100%; padding:10px; margin-bottom:10px; border:1px solid #ccc; border-radius:6px;">
        <input type="password" id="txtPassword" placeholder="Password" style="width:100%; padding:10px; margin-bottom:20px; border:1px solid #ccc; border-radius:6px;">
        
        <button onclick="handleLogin()" class="btn-primary" style="width:100%;">Sign In</button>
        <a href="#" onclick="handleForgotPassword()" style="color:#94a3b8; font-size:0.8rem; margin-top:15px; display:inline-block; text-decoration:none;">Forgot Password?</a>
        <p id="loginError" style="color:red; margin-top:15px; font-size:0.9rem;"></p>
    </div>
</div>
<div id="settingsModal" class="modal" style="display:none; position:fixed; z-index:9000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.5); align-items:center; justify-content:center;">
    <div class="modal-content" style="background:white; padding:20px; border-radius:8px; width:300px;">
        <h3>Change Password</h3>
        <input type="password" id="newPassword" placeholder="New Password" style="width:100%; padding:8px; margin:10px 0;">
        <button onclick="changeMyPassword()" class="btn-primary" style="width:100%;">Update Password</button>
        <button onclick="document.getElementById('settingsModal').style.display='none'" class="btn-secondary" style="width:100%; margin-top:10px;">Cancel</button>
    </div>
</div>

<div id="addUserModal" class="modal" style="display:none; position:fixed; z-index:9000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.5); align-items:center; justify-content:center;">
    <div class="modal-content" style="background:white; padding:20px; border-radius:8px; width:500px; max-width:95%; max-height:90vh; overflow-y:auto;">
        <h3>Create New User</h3>
        <h3>Create New User</h3>
        <input type="text" id="newUserName" placeholder="Full Name" style="width:100%; padding:8px; margin:5px 0;">       
    
        <input type="email" id="newUserEmail" placeholder="Email Address" style="width:100%; padding:8px; margin:5px 0;">
        <input type="text" id="newUserTempPass" value="Wendy2025!" placeholder="Temp Password" style="width:100%; padding:8px; margin:5px 0;">
        
        <label>Role:</label>
        <select id="newUserRole" onchange="toggleNewUserScopeSections()" style="width:100%; padding:8px; margin:5px 0 15px 0;">
            <option value="store">Store / Site</option> 
            <option value="market">Market Operator</option>
            <option value="district">District Manager</option>
            <option value="admin">Admin</option>
        </select>

        <div id="section-new-market" class="scope-section" style="display:none;">
            <div class="scope-header">Select Market(s)</div>
            <div class="checkbox-list" id="listNewMarkets">Loading...</div>
        </div>

        <div id="section-new-district" class="scope-section" style="display:none;">
            <div class="scope-header">Select District(s)</div>
            <div class="checkbox-list" id="listNewDistricts">Loading...</div>
        </div>

        <div id="section-new-site" class="scope-section">
            <div class="scope-header">
                <span>Select Site(s)</span>
                <input type="text" placeholder="Search sites..." onkeyup="filterCheckboxList('listNewSites', this.value)" style="font-size:0.7rem; padding:2px;">
            </div>
            <div class="checkbox-list" id="listNewSites">Loading...</div>
        </div>
        
        <label style="font-size:0.8rem; display:flex; align-items:center; gap:5px; margin-top:10px;">
            <input type="checkbox" id="newUserForceReset" checked> Force Password Change on First Login
        </label>

        <button onclick="createNewUser()" class="btn-primary" style="width:100%; margin-top:15px;">Create User</button>
        <button onclick="document.getElementById('addUserModal').style.display='none'" class="btn-secondary" style="width:100%; margin-top:10px;">Cancel</button>
    </div>
</div>
<div id="editUserModal" class="modal" style="display:none; position:fixed; z-index:9000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.5); align-items:center; justify-content:center;">
    <div class="modal-content" style="background:white; padding:20px; border-radius:8px; width:500px; max-width:95%; max-height:90vh; overflow-y:auto;">
        <h3>Edit User Permissions</h3>
        
        <p style="margin-bottom:15px; color:#64748b;">
            Editing: <strong id="editUserEmailDisplay" style="color:#334155;">...</strong>
        </p>
        
        <label>Full Name:</label>
        <input type="text" id="editUserName" placeholder="User Full Name" style="width:100%; padding:8px; margin:5px 0 15px 0;">

        <label>Role:</label>
        <select id="editUserRole" onchange="toggleScopeSections()" style="width:100%; padding:8px; margin:5px 0 15px 0;">
            <option value="store">Store / Site</option> 
            <option value="market">Market Operator</option>
            <option value="district">District Manager</option>
            <option value="admin">Admin</option>
        </select>

        <div id="section-market" class="scope-section" style="display:none;">
            <div class="scope-header">Select Market(s)</div>
            <div class="checkbox-list" id="listMarkets">Loading...</div>
        </div>

        <div id="section-district" class="scope-section" style="display:none;">
            <div class="scope-header">Select District(s)</div>
            <div class="checkbox-list" id="listDistricts">Loading...</div>
        </div>

        <div id="section-site" class="scope-section">
            <div class="scope-header">
                <span>Select Site(s)</span>
                <input type="text" placeholder="Search sites..." onkeyup="filterCheckboxList('listSites', this.value)" style="font-size:0.7rem; padding:2px;">
            </div>
            <div class="checkbox-list" id="listSites">Loading...</div>
        </div>

        <div style="display:flex; gap:10px; margin-top:20px;">
            <button onclick="saveUserChanges()" class="btn-primary" style="flex:1;">Save Changes</button>
            <button onclick="document.getElementById('editUserModal').style.display='none'" class="btn-secondary" style="flex:1;">Cancel</button>
        </div>
    </div>
</div>
<script src="auth_logic.js"></script>
<script src="admin_logic.js"></script>  
<script src="jolt_logic.js"></script>
</body>
</html>