<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jolt Operations Dashboard</title>
    <link rel="stylesheet" href="jolt_styles.css">
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
</head>
<body>

<div class="dashboard-container">
    
    <!-- LEFT SIDEBAR (Desktop) / BOTTOM NAV (Mobile) -->
    <aside class="sidebar">
        <div class="brand">
            <h1>‚ö° Jolt Ops</h1>
            <p>Dashboard</p>
        </div>

        <nav class="nav-menu">
            
            <!-- SECTION 1: LISTS -->
            <div class="nav-section">
                <div class="nav-header">Lists</div>
                <button id="nav-inspector" class="nav-btn active" onclick="switchTab('inspector')">
                    <span class="icon">üìã</span> <span class="label">List Inspector</span>
                </button>
            </div>

            <!-- SECTION 2: FOOD SAFETY -->
           <div class="nav-section">
                <div class="nav-header">Food Safety</div>
                <button id="nav-grid" class="nav-btn" onclick="switchTab('grid')">
                    <span class="icon">üìä</span> <span class="label">DFSL Grid</span>
                </button>
                <button id="nav-report" class="nav-btn" onclick="switchTab('report')">
                    <span class="icon">üìÑ</span> <span class="label">DFSL Report</span>
                </button>
                <button id="nav-probeGrid" class="nav-btn" onclick="switchTab('probeGrid')">
                    <span class="icon">üå°Ô∏è</span> <span class="label">Probe & Sensor</span>
                </button>
            </div>

            <!-- SECTION 3: MONTHLY SAFETY -->
            <div class="nav-section">
                <div class="nav-header">Monthly Safety</div>
                <button id="nav-audits" class="nav-btn" onclick="switchTab('audits')">
                    <span class="icon">üõ°Ô∏è</span> <span class="label">Safety Audits</span>
                </button>
                <button id="nav-safety-grid" class="nav-btn" onclick="switchTab('safety-grid')">
                    <span class="icon">‚õëÔ∏è</span> <span class="label">Safety Grid</span>
                </button>
                
            </div>
            <div id="nav-admin-section" class="nav-section" style="display:none;">
            <div class="nav-header">Admin Controls</div>
             <button id="nav-admin" class="nav-btn" onclick="switchTab('admin')">
              <span class="icon">‚öôÔ∏è</span> <span class="label">Control Panel</span>
             </button>
            </div>

        </nav>

        <div class="sidebar-footer">
    <button onclick="handleLogout()" class="config-trigger" style="
    background-color: #fff; 
    color: #dc2626; 
    border: 1px solid #dc2626; 
    margin-bottom: 10px; 
    font-weight: bold;">
    üö™ Log Out
</button>
    
    <button onclick="document.getElementById('configModal').style.display='flex'" class="config-trigger">
        ‚öôÔ∏è Settings
    </button>
</div>
    </aside>

    <!-- MAIN CONTENT AREA -->
    <main class="content-area">
        
        <!-- Header for Mobile/Context -->
        <header class="mobile-header">
            <h2>Operations Dashboard</h2>
        </header>

        <!-- VIEW 1: INSPECTOR -->
        <div id="tab-inspector" class="view-content active">
    <div class="card">
        <div class="card-header">
            <h2>List Inspector</h2>
            <div class="legend-box hide-mobile">
                <span class="legend-item">üõ°Ô∏è Score</span>
                <span class="legend-item"><span style="color:red">üî¥</span> Expired</span>
                <span class="legend-item"><span style="color:gold">üü°</span> Due Today</span>
            </div>
        </div>

        <div class="controls-bar">
            <details open class="filter-toggle">
                <summary class="btn-secondary filter-summary">‚öôÔ∏è Show Filters</summary>
                <div class="filter-content">
                    <div class="control-group">
                        <label>Location</label>
                        <select id="locationSelect"><option>Loading...</option></select>
                    </div>
                    <div class="control-group">
                        <label>Start Date</label>
                        <input type="date" id="startDate">
                    </div>
                    <div class="control-group">
                        <label>End Date</label>
                        <input type="date" id="endDate">
                    </div>
                    <div class="button-group">
                        <button class="btn-primary" onclick="fetchChecklists()">View Checklists</button>
                        <button class="btn-secondary" onclick="exportCurrentView()">Export</button>
                    </div>
                </div>
            </details>
        </div>

        <div class="split-view">
            <div class="list-sidebar" id="listSidebar">
                <div class="empty-state">Select filters to load lists</div>
            </div>
            
            <div class="detail-panel mobile-hidden" id="detailView">
                <div class="mobile-nav-header">
                        <button class="btn-secondary back-btn" onclick="backToMobileList('listSidebar', 'detailView')">‚Üê Back to List</button>
                </div>
                <div class="empty-state">
                    <h3>Select a list</h3>
                    <p>Details will appear here</p>
                </div>
            </div>
        </div>
    </div>
</div>

        <!-- VIEW 2: DFSL GRID (Renamed) -->
        <div id="tab-grid" class="view-content">
            <div class="card">
                <div class="card-header">
                    <h2>DFSL Grid</h2>
                </div>
                <div class="controls-bar">
                    <details open class="filter-toggle">
                        <summary class="btn-secondary filter-summary">‚öôÔ∏è Show Filters</summary>
                        <div class="filter-content">
                            <div class="control-group">
                                <label>Date</label>
                                <input type="date" id="gridDate">
                            </div>
                            
                            <!-- FILTERS -->
                            <div class="control-group">
                                <label>Market</label>
                                <select id="marketFilter">
                                    <option value="">All Markets</option>
                                    <option disabled>Loading...</option>
                                </select>
                            </div>
                            <div class="control-group">
                                <label>District</label>
                                <select id="districtFilter">
                                    <option value="">All Districts</option>
                                    <option disabled>Loading...</option>
                                </select>
                            </div>

                            <div class="button-group">
                                <button class="btn-primary" onclick="loadStoreGrid()">Load Grid</button>
                                <button class="btn-secondary" onclick="printGrid()">Print / Save PDF</button>
                                <button class="btn-secondary" onclick="exportGridToCSV()">Export CSV</button>
                            </div>
                        </div>
                    </details>
                </div>
                
                <div class="table-responsive">
                    <div id="gridPrintHeader" class="only-print"></div>
                    <table class="modern-table" id="storeTable">
                        <thead>
                            <tr>
                                <th>Store Name</th>
                                <th>Daypart 1</th>
                                <th>Daypart 3</th>
                                <th>Daypart 5</th>
                                <th>Sanitizer</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="5" style="text-align:center; padding:30px;">No data loaded.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- VIEW 3: SAFETY GRID -->
        <div id="tab-safety-grid" class="view-content">
            <div class="card">
                <div class="card-header">
                    <h2>Safety Audit Grid</h2>
                </div>
                <div class="controls-bar">
                    <details open class="filter-toggle">
                        <summary class="btn-secondary filter-summary">‚öôÔ∏è Show Filters</summary>
                        <div class="filter-content">
                            <div class="control-group">
                                <label>Month</label>
                                <input type="month" id="safetyMonth">
                            </div>
                            <div class="control-group">
                                <label>Market</label>
                                <select id="safetyMarketFilter">
                                    <option value="">All Markets</option>
                                    <option disabled>Loading...</option>
                                </select>
                            </div>
                            <div class="control-group">
                                <label>District</label>
                                <select id="safetyDistrictFilter">
                                    <option value="">All Districts</option>
                                    <option disabled>Loading...</option>
                                </select>
                            </div>
                            <div class="button-group">
                                <button class="btn-primary" onclick="loadSafetyGrid()">Load Grid</button>
                                <button class="btn-secondary" onclick="printSafetyGrid()">Print / Save PDF</button>
                                <button class="btn-secondary" onclick="exportSafetyGridCSV()">Export CSV</button>
                            </div>
                        </div>
                    </details>
                </div>
                
                <div class="table-responsive">
                    <div id="safetyPrintHeader" class="only-print"></div>
                    <table class="modern-table" id="safetyTable">
                        <thead>
                            <tr>
                                <th>Site</th>
                                <th>Monthly Safety Audit</th>
                                <th>Safety Committee Agenda</th>
                                <th>Complete?</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="4" style="text-align:center; padding:30px;">No data loaded.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- VIEW 4: REPORT -->
        <div id="tab-report" class="view-content">
            <div class="card">
                <div class="controls-bar no-print">
                    <details open class="filter-toggle">
                        <summary class="btn-secondary filter-summary">‚öôÔ∏è Show Filters</summary>
                        <div class="filter-content">
                            <div class="control-group">
                                <label>Location</label>
                                <select id="reportLocationSelect"><option>Loading...</option></select>
                            </div>
                            <div class="control-group">
                                <label>Date</label>
                                <input type="date" id="reportDate">
                            </div>
                            <div class="button-group">
                                <button class="btn-primary" onclick="generateSingleReport()">Generate</button>
                                <button class="btn-secondary" onclick="window.print()">Print/PDF</button>
                            </div>
                        </div>
                    </details>
                </div>

                <div class="report-wrapper">
                    <div class="report-page" id="reportContent">
                        <div class="empty-state">Select Location & Date to generate report.</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW 5: AUDITS -->
        <div id="tab-audits" class="view-content">
            <div class="card">
                <div class="card-header">
                    <h2>Safety Audits (Detail)</h2>
                </div>
                <div class="controls-bar no-print">
                    <details open class="filter-toggle">
                        <summary class="btn-secondary filter-summary">‚öôÔ∏è Show Filters</summary>
                        <div class="filter-content">
                            <div class="control-group">
                                <label>Location</label>
                                <select id="auditLocationSelect"><option>Loading...</option></select>
                            </div>
                            <div class="control-group">
                                <label>Month</label>
                                <input type="month" id="auditMonth">
                            </div>
                            <div class="button-group">
    <button class="btn-primary" onclick="fetchAudits()">View Audits</button>
    <button class="btn-secondary" onclick="window.print()">Print</button>
</div>
                        </div>
                    </details>
                </div>

                <div class="split-view">
                    <div class="list-sidebar" id="auditSidebar">
                        <div class="empty-state">Select location & month</div>
                    </div>
                    
                    <div class="detail-panel mobile-hidden" id="auditDetailView">
                         <div class="mobile-nav-header">
                            <button class="btn-secondary back-btn" onclick="backToMobileList('auditSidebar', 'auditDetailView')">‚Üê Back to List</button>
                       </div>
                        <div class="empty-state">
                            <h3>Select an audit</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="tab-probeGrid" class="view-content">
    <div class="card">
        <div class="card-header">
            <h2>Probe & Sensor Report</h2>
        </div>
        <div class="controls-bar">
            <details open class="filter-toggle">
                <summary class="btn-secondary filter-summary">‚öôÔ∏è Show Filters</summary>
                <div class="filter-content">
                    
                    <div class="control-group">
                        <label>Start Date</label>
                        <input type="date" id="probeStartDate_v2">
                    </div>
                    <div class="control-group">
                        <label>End Date</label>
                        <input type="date" id="probeEndDate_v2">
                    </div>
                    
                    <div class="control-group">
                        <label>Market</label>
                        <select id="probeMarketFilter_v2" onchange="updateProbeFilters_v2('market')">
                            <option value="">All Markets</option>
                            <option disabled>Loading...</option>
                        </select>
                    </div>

                    <div class="control-group">
                        <label>District</label>
                        <select id="probeDistrictFilter_v2" onchange="updateProbeFilters_v2('district')">
                            <option value="">All Districts</option>
                            <option disabled>Loading...</option>
                        </select>
                    </div>

                    <div class="control-group">
                        <label>Location</label>
                        <select id="probeLocationFilter_v2">
                            <option value="">All Locations</option>
                            <option disabled>Select District...</option>
                        </select>
                    </div>

                    <div class="control-group">
                        <label>&nbsp;</label> <label style="cursor:pointer; display:flex; align-items:center; gap:6px; height:38px; white-space:nowrap; font-weight:600; color:#334155;">
                            <input type="checkbox" id="probeGroupToggle_v2" style="margin:0; min-width:auto; width:auto;"> Group By Organization
                        </label>
                    </div>

                    <div class="button-group">
                        <button class="btn-primary" onclick="loadProbeGrid_v2()">Load Grid</button>
                        <button class="btn-secondary" onclick="window.print()">Print / PDF</button>
                        <button class="btn-secondary" onclick="exportProbeGridCSV_v2()">Export CSV</button>
                    </div>
                </div>
            </details>
        </div>
        
        <div class="table-responsive">
            <div id="probePrintHeader" class="only-print"></div>
            <table class="modern-table" id="probeTable">
                <thead>
                    <tr>
                        <th>Site Name</th>
                        <th>Probe Usage %</th>
                        <th>Sensor Usage %</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="3" style="text-align:center; padding:30px;">Select filters and click Load Grid.</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
      <div id="tab-admin" class="view-content">
    <div class="card">
        <div class="card-header">
            <h2>User Control Panel</h2>
            <button class="btn-primary" onclick="document.getElementById('addUserModal').style.display='flex'">+ New User</button>
        </div>
        <div class="table-responsive">
            <table class="modern-table" id="adminUserTable">
                <thead>
                    <tr>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Scope</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>


    </main>
</div>

<!-- MODALS -->
<div id="photoModal"><div class="photo-content"><button class="close-photo" onclick="closePhoto()">Close</button><h3 id="photoTitle">Photo Details</h3><div class="photo-placeholder"><span>Image Preview Unavailable via API</span></div><p id="photoCaption" style="font-family:monospace; color:#333; word-break:break-all;"></p></div></div>
<div id="loadingOverlay"><div class="loader"></div><h2 id="loadingText">Processing...</h2><p id="loadingSubtext">Please wait.</p></div>
<div id="system-log" style="display:none;"></div>
<div id="configModal"><div class="modal-content"><h3>API Connection Settings</h3><p style="font-size: 0.8rem; color: #666;">Adjust these only if connection fails.</p><div class="modal-row"><label>Proxy URL (Worker)</label><input type="text" id="cfg-url" value="https://jolt-proxy.ckuran.workers.dev"></div><div class="modal-row" style="opacity: 0.5;"><label>Auth Token (Managed by Worker)</label><input type="text" id="cfg-token-val" placeholder="(Hidden)" disabled></div><div style="text-align: right; margin-top: 15px;"><button onclick="saveConfig()" class="btn-primary">Save & Reload</button><button onclick="document.getElementById('configModal').style.display='none'" style="padding: 9px;">Cancel</button></div></div></div>
<div id="loginOverlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#1e293b; z-index:9999; display:flex; justify-content:center; align-items:center; flex-direction:column; color:white;">
    <div style="background:white; padding:40px; border-radius:12px; box-shadow:0 10px 25px rgba(0,0,0,0.5); text-align:center; color:#333; max-width:400px; width:90%;">
        <h1 style="margin-bottom:10px;">‚ö° Jolt Ops</h1>
        <p style="color:#666; margin-bottom:20px;">Please sign in to access the dashboard.</p>
        
        <input type="email" id="txtEmail" placeholder="Email" style="width:100%; padding:10px; margin-bottom:10px; border:1px solid #ccc; border-radius:6px;">
        <input type="password" id="txtPassword" placeholder="Password" style="width:100%; padding:10px; margin-bottom:20px; border:1px solid #ccc; border-radius:6px;">
        
        <button onclick="handleLogin()" class="btn-primary" style="width:100%;">Sign In</button>
        <p id="loginError" style="color:red; margin-top:15px; font-size:0.9rem;"></p>
    </div>
</div>
<div id="settingsModal" class="modal" style="display:none; position:fixed; z-index:9000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.5); align-items:center; justify-content:center;">
    <div class="modal-content" style="background:white; padding:20px; border-radius:8px; width:300px;">
        <h3>Change Password</h3>
        <input type="password" id="newPassword" placeholder="New Password" style="width:100%; padding:8px; margin:10px 0;">
        <button onclick="changeMyPassword()" class="btn-primary" style="width:100%;">Update Password</button>
        <button onclick="document.getElementById('settingsModal').style.display='none'" class="btn-secondary" style="width:100%; margin-top:10px;">Cancel</button>
    </div>
</div>

<div id="addUserModal" class="modal" style="display:none; position:fixed; z-index:9000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.5); align-items:center; justify-content:center;">
    <div class="modal-content" style="background:white; padding:20px; border-radius:8px; width:350px;">
        <h3>Create New User</h3>
        <input type="email" id="newUserEmail" placeholder="Email Address" style="width:100%; padding:8px; margin:5px 0;">
        <input type="text" id="newUserTempPass" value="Wendy2025!" placeholder="Temp Password" style="width:100%; padding:8px; margin:5px 0;">
        
        <label>Role:</label>
        <select id="newUserRole" style="width:100%; padding:8px; margin:5px 0;">
        <option value="store">Store / Site</option> 
        <option value="market">Market Operator</option>
        <option value="district">District Manager</option>
        <option value="admin">Admin</option>
        </select>

        <label>Scope (Market/District Name):</label>
        <input type="text" id="newUserScope" placeholder="e.g. Wenspok or Nikki Brown" style="width:100%; padding:8px; margin:5px 0;">
        
        <label style="font-size:0.8rem; display:flex; align-items:center; gap:5px;">
            <input type="checkbox" id="newUserForceReset" checked> Force Password Change on First Login
        </label>

        <button onclick="createNewUser()" class="btn-primary" style="width:100%; margin-top:15px;">Create User</button>
        <button onclick="document.getElementById('addUserModal').style.display='none'" class="btn-secondary" style="width:100%; margin-top:10px;">Cancel</button>
    </div>
</div>
<script src="auth_logic.js"></script>
<script src="admin_logic.js"></script>  
<script src="jolt_logic.js"></script>
</body>
</html>